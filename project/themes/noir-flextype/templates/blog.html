{% extends 'themes/' ~ registry.get('plugins.site.settings.theme') ~ '/templates/partials/base.html' %}

{% block content %}

    {% set page = query.page %}
    {% set tag = query.tag %}
    {% set blog_posts_limit = 5 %}

    {% set blogCacheID = strings('blogCacheID' ~ entry.id).hash().toString() %}
    {% if cache.has(blogCacheID) %}
        {% set blog = cache.get(blogCacheID) %}
    {% else %}
        {% set blog = entries.fetch(locale() ~ '/blog', {'collection': true}) %}
        {% do cache.set(blogCacheID, blog) %}
    {% endif %}

    {% if tag %}

        {% set blog_posts_length = blog.copy()
                                       .where('tags', 'contains', tag)
                                       .where('visibility', 'nin', ['draft', 'hidden'])
                                       .count() %}

        {% set blog_posts_pages = (blog_posts_length/blog_posts_limit)|round(0, 'ceil') %}
        {% if page < 1 %}
            {% set page = 1 %}
        {% elseif page > blog_posts_pages %}
            {% set page = blog_posts_pages %}
        {% endif %}
        {% set blog_posts_offset = (page-1)*blog_posts_limit %}
        {% if blog_posts_offset < 0 %}{% set blog_posts_offset = 0 %}{% endif %}

        {% set blog_posts = blog.copy()
                                .where('tags', 'contains', tag)
                                .where('visibility', 'nin', ['draft', 'hidden'])
                                .sortBy('published_at', 'DESC')
                                .slice(blog_posts_offset, blog_posts_limit) %}
    {% else %}

        {% set blog_posts_length = blog.copy()
                                       .where('visibility', 'nin', ['draft', 'hidden'])
                                       .count() %}

        {% set blog_posts_pages = (blog_posts_length/blog_posts_limit)|round(0, 'ceil') %}

        {% if page < 1 %}
            {% set page = 1 %}
        {% elseif page > blog_posts_pages %}
            {% set page = blog_posts_pages %}
        {% endif %}

        {% set blog_posts_offset = (page-1)*blog_posts_limit %}
        {% if blog_posts_offset < 0 %}{% set blog_posts_offset = 0 %}{% endif %}

        {% set blog_posts = blog.copy()
                                .where('visibility', 'nin', ['draft', 'hidden'])
                                .sortBy('published_at', 'DESC')
                                .slice(blog_posts_offset, blog_posts_limit) %}

    {% endif %}

    <div class="container mx-auto bg-white text-black pb-24">
        <h1 class="uppercase text-center text-3xl lg:text-6xl pt-24 pb-24 m-0">
            {{ entry.title|raw }}
        </h1>
        <div class="flex content-center flex-wrap">
            <div class="w-full lg:w-9/12 p-2 text-left">
                {% for post in blog_posts %}
                <a href="{{ url() }}/{{ post.id }}" class="flex align-middle mb-6 px-6 post wow fadeIn">
                    <h4 class="w-8/12 text-xl pb-0 mb-0">{{ post.title }}</h4>
                    <div class="w-4/12 text-xl text-right opacity-50">
                        {{ post.published_at|date(registry.get('flextype.settings.date_display_format')) }}
                    </div>
                </a>
                {% endfor %}

                {# pagination navigation #}
                <div class="text-center">
                    {% if (page - 1) > 0 %}
                        <a href="?page={{ page - 1 }}{% if tag %}&tag={{ tag }}{% endif %}">&larr;</a>
                    {% endif %}
                    {% if blog_posts_pages is not null and blog_posts_pages > 1 %}
                        {{ page }} / {{ blog_posts_pages }}
                    {% endif %}
                    {% if (page) < blog_posts_pages %}
                        <a href="?page={{ page + 1 }}{% if tag %}&tag={{ tag }}{% endif %}">&rarr;</a>
                    {% endif %}
                </div>
                {# /pagination navigation #}

            </div>
            <div class="w-full lg:w-3/12 p-2 wow fadeIn">
                <div class="text-black text-left p-6 plate">
                    {# tags-cloud #}
                    {% set tags_cloud = [] %}
                    {% for post in blog.copy()
                                       .where('visibility', 'nin', ['draft', 'hidden'])
                                       .sortBy('published_at', 'DESC') %}
                        {% set tags = post.tags|replace({' ': ''}) %}
                        {% set tags_cloud = tags_cloud|merge(post.tags|split(',')) %}
                    {% endfor %}

                    {% if tags_cloud|length > 0 %}
                        <h4 class="text-left mb-2">Tags</h4>
                        {% for tag in tags_cloud|reduce((unique, item) => item in unique ? unique : unique|merge([item]), [])  %}
                            <a class="no-underline px-2 mb-2 block" href="{{ url() }}/{{ locale() }}/blog?tag={{ tag|trim }}">#{{ tag|trim }}</a>
                        {% endfor %}
                    {% endif %}
                    {# /tags-cloud #}
                </div>
            </div>
        </div>
    </div>
{% endblock %}
